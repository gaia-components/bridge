(function p(f,d,g){function m(e,b){if(!d[e]){if(!f[e]){var c="function"==typeof require&&require;if(!b&&c)return c(e,!0);if(k)return k(e,!0);c=Error("Cannot find module '"+e+"'");throw c.code="MODULE_NOT_FOUND",c;}c=d[e]={h:{}};f[e][0].call(c.h,function(a){var c=f[e][1][a];return m(c?c:a)},c,c.h,p,f,d,g)}return d[e].h}for(var k="function"==typeof require&&require,h=0;h<g.length;h++)m(g[h]);return m})({1:[function(l){var f={service:l("../src/service"),client:l("../src/client"),ta:l("../src/message")};
"u"!=(typeof define)[0]?define([],function(){return f}):self.threads=f},{"../src/client":2,"../src/message":4,"../src/service":6}],2:[function(l,f){function d(c,a){if(!(this instanceof d))return new d(c,a);this.id=e();this.w=c;this.A=a||this.A;if(!this.A)throw g(1);this.P(this.A);this.i=new Set;this.m=h.m(this.id).b("_push",this.ga.bind(this))}function g(c,a){a=[].slice.call(arguments,1);return Error({1:"an endpoint must be defined",2:'Unable to establish a connection with "'+a[0]+'". Either the target endpoint is not alive or the Service is not `.listen()`ing.',
3:'Method "'+a[0]+"\" didn't get a response. Either the target endpoint is not alive or the Service is not `.listen()`ing."}[c])}var m=l("./message/port-adaptors"),k=l("./emitter"),h=l("./message"),e=l("./utils").K;f.h=d;d.prototype={connect:function(){var c=this;if(this.B)return this.B;var a=new MessageChannel;this.channel=a.port1;this.channel.start();var b={C:this.id,w:this.w};return this.B=this.message("_connect").set("transfer",[a.port2]).set("data",b).l(a.port1).send().then(function(a){a.event.target===
c.channel?c.P(c.channel):(c.channel.close(),delete c.channel);c.m.l(c.port)}).catch(function(a){"timeout"==(a&&a.message)&&(a=g(2,c.w),console.error(a.message));throw a;})},disconnect:function(c){var a=this;if(!this.B)return Promise.resolve();c={f:c&&c.f,data:this.id};this.ca();return this.message("_disconnect").set(c).send().then(function(){return a.fa()})},method:function(c,a){var b=this;a=[].slice.call(arguments,1);return this.connect().then(function(){return b.message("_method").set({s:b.w,data:{name:c,
X:a}}).send()}).then(function(a){return a.value}).catch(function(a){"timeout"==(a&&a.message)&&(a=g(3,c),console.error(a.message));throw a;})},G:function(c){c(this,{Emitter:k,uuid:e});return this},message:function(c){var a=this,b=h(c).set("port",this.port).b("response",function(){return a.i.delete(b)}).b("cancel",function(){return a.i.delete(b)});this.i.add(b);return b},ca:function(){this.i.forEach(function(c){c.cancel()});this.i.clear()},ha:function(){var c=[];this.i.forEach(function(a){return c.push(a.ua)});
return Promise.all(c)},ga:function(c){this.O(c.data.type,c.data.data)},fa:function(){var c=this;delete this.B;this.ha().then(function(){c.channel&&c.channel.close();c.O("disconnected")})},P:function(c){this.port=m(c)},g:function(){var c=this;return this.disconnect().then(function(){c.ea||(c.ea=!0,c.m.g(),c.ba(),c.port=c.A=c.m=null)})},ba:k.prototype.o,O:k.prototype.a};d.prototype.b=function(c,a){var b=this;this.connect().then(function(){k.prototype.b.call(b,c,a);b.message("_on").set("noRespond",!0).set("data",
{name:c,C:b.id}).send(b.port)});return this};d.prototype.o=function(c,a){var b=this;this.connect().then(function(){k.prototype.o.call(b,c,a);b.message("_off").set("noRespond",!0).set("data",{name:c,C:b.id}).send(b.port)});return this};var b=d.prototype;b.destroy=b.g;b.plugin=b.G;b.method=b.method;b.connect=b.connect;b.disconnect=b.disconnect;b.on=b.b;b.off=b.o},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":7}],3:[function(l,f){function d(f){if(f)return Object.assign(f,d.prototype)}
f.h=d;d.prototype={b:function(d,f){this.c||(this.c={});this.c[d]||(this.c[d]=[]);this.c[d].push(f);return this},o:function(d,f){if(this.c)switch(arguments.length){case 0:this.c={};break;case 1:delete this.c[d];break;default:var g=this.c[d];if(!g)return;var e=g.indexOf(f);~e&&g.splice(e,1)}return this},a:function(d,f){if(this.c)for(var g=this.c[d]||[],g=g.concat(this.c["*"]||[]),e=0;e<g.length;e++)g[e].call(this,f,d);return this}};var g=d.prototype;g.off=g.o;g.on=g.b},{}],4:[function(l,f,d){function g(a){this.N=
!1;this.M=null;this.D=[];this.j=b();this.onMessage=this.onMessage.bind(this);this.F=this.F.bind(this);"object"===typeof a?this.pa(a):this.qa(a)}function m(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);this.unlisten=this.unlisten.bind(this)}function k(a){return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}var h=l("./port-adaptors"),e=l("../emitter");l=
l("../utils");var b=l.j,c=l.K;d=f.h=function(a){return new g(a)};d.m=function(a){return new m(a)};d.L=m;d.i=g;g.prototype={timeout:1E3,qa:function(a){this.id=c();this.type=a;this.na=!1;this.s="*"},pa:function(a){this.R=!1;this.T(a.source||a.target);this.event=a;Object.assign(this,a.data)},T:function(a){this.I=h(a,{ready:!0});return this},set:function(a,b){"object"==typeof a?Object.assign(this,a):this[a]=b;return this},oa:function(){return{id:this.id,type:this.type,data:this.data,s:this.s,f:this.f}},
V:function(){this.defaultPrevented=!0},send:function(a){if(this.na)throw k(1);var b=this.oa(),c=!this.f;this.port=a?h(a):this.port;if(!this.port)throw k(3);c?(this.l(this.port),this.M=setTimeout(this.F,this.timeout)):this.j.resolve();this.port.postMessage(b,this.aa());return this.j.H},aa:function(){return this.ra||this.event&&this.event.ports},onMessage:function(a){a.data.response&&a.data.id===this.id&&!this.N&&this.ma(a)},F:function(){this.va||this.j.reject(k(4));this.J()},l:function(a){a=h(a);a.addListener(this.onMessage);
this.D.push(a);return this},v:function(){var a=this;this.D.forEach(function(b){return b.removeListener(a.onMessage)});this.D=[]},cancel:function(){this.J();this.N=!0;this.a("cancel")},J:function(){clearTimeout(this.M);this.v()},u:function(a){function b(a){e({type:"resolve",value:a})}function c(a){e({type:"reject",value:a&&a.message||a})}function e(a){d.response=a;d.I.postMessage({id:d.id,response:a},d.ra)}if(this.R)throw k(2);if(this.I&&!this.f){var d=this;this.R=!0;a instanceof Error&&c(a);Promise.resolve(a).then(b,
c).catch(c)}},U:function(a){var b=this;return this.set("silentTimeout",!0).send(a).then(function(a){return b.u(a.value)})},ma:function(a){var b=a.data.response,c="reject"==b.type?b.value:b;b.event=a;this.response=b;this.J();this.j[this.response.type](c);this.a("response",b)}};f=g.prototype;f.forward=f.U;f.respond=f.u;f.preventDefault=f.V;f.cancel=f.cancel;f.send=f.send;f.set=f.set;e(g.prototype);m.prototype={l:function(a){a=h(a||self,{m:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,
this.l),this.ports.add(a),this},v:function(){var a=this;this.ports.forEach(function(b){b.removeListener(a.onMessage,a.v)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.da(a.data.s)&&(a=new g(a),this.a("message",a),!a.defaultPrevented))try{this.a(a.type,a)}catch(b){throw a.u(b),b;}},da:function(a){return a==this.name||"*"==a||"*"==this.name},g:function(){this.v();delete this.name;return this}};f=m.prototype;f.listen=f.l;f.unlisten=f.v;f.destroy=f.g;e(m.prototype)},{"../emitter":3,"../utils":7,
"./port-adaptors":5}],5:[function(l,f){function d(b){this.target=b}function g(b,c,a){b.addEventListener(c,a)}var m=l("../utils").j;f.h=function(b,c){if(!b)throw Error({1:"target is undefined"}[1]);if(b&&b.addListener)return b;var a=h[b.constructor.name];return a?a(b,c):new d(b)};var k=d.prototype={constructor:d,addListener:function(b){this.target.addEventListener("message",b)},removeListener:function(b){this.target.removeEventListener("message",b)},postMessage:function(b,c){this.target.postMessage(b,
c)}},h={HTMLIFrameElement:function(b){var c=e(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(a,e){c.then(function(){b.contentWindow.postMessage(a,"*",e)})}}},sa:function(b,c){function a(){var a=m();b.postMessage("ready?");g(b,"message",function n(c){"ready"==c.data&&(b.removeEventListener("message",n),a.resolve())});return a.H}var e=c&&c.m,d=c&&c.ready,d=d||e?Promise.resolve():a();e&&
(b.postMessage("ready"),g(b,"message",function(a){"ready?"==a.data&&b.postMessage("ready")}));return{target:b,addListener:k.addListener,removeListener:k.removeListener,postMessage:function(a,c){d.then(function(){return b.postMessage(a,c)})}}},Window:function(b,c){var a=c&&c.ready||b===self,a=a?Promise.resolve():e(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(c,e){a.then(function(){return b.postMessage(c,
"*",e)})}}},SharedWorkerGlobalScope:function(){var b=[];return{postMessage:function(){},addListener:function(c,a){this.onconnect=function(c){c=c.ports[0];b.push(c);c.start();a(c)};self.addEventListener("connect",this.onconnect)},removeListener:function(c,a){self.removeEventListener("connect",this.onconnect);b.forEach(function(b){b.close();a(b)})}}}},e=function(){if("undefined"!=typeof window){var b=window.opener||window.parent,c=new WeakSet;b!=self&&g(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",
q);b.postMessage("load","*")});g(self,"message",function(b){return"load"==b.data&&c.add(b.source)});return function(b){var e=b.contentWindow||b;if(c.has(e)||e==window.parent)return Promise.resolve();var d=m();g(window,"message",function n(b){"load"==b.data&&b.source==e&&(window.removeEventListener("message",n),d.resolve())});return d.H}}}()},{"../utils":7}],6:[function(l,f){function d(e){if(!(this instanceof d))return new d(e);k.L.call(this,e);this.clients={};this.methods={};this.b("_disconnect",
this.onDisconnect.bind(this)).b("_connect",this.ia.bind(this)).b("_method",this.ja.bind(this)).b("_off",this.ka.bind(this)).b("_on",this.la.bind(this));this.g=this.g.bind(this)}function g(e){return Error({4:'method "'+[].slice.call(arguments,1)[0]+"\" doesn't exist"}[e])}var m=l("./utils").K,k=l("./message"),h=k.L;f.h=d;d.prototype=Object.create(h.prototype);d.prototype.method=function(e,b){this.methods[e]=b;return this};d.prototype.Y=function(e,b,c){var a=this;this.Z(function(d){c&&!~c.indexOf(d.id)||
a.push(e,b,d.id,{f:!0})});return this};d.prototype.push=function(e,b,c,a){a=a&&a.f;var d=this.$(c);return k("_push").set({s:c,f:a,data:{type:e,data:b}}).send(d.port)};d.prototype.Z=function(e){for(var b in this.clients)e(this.clients[b])};d.prototype.$=function(e){return this.clients[e]};d.prototype.ia=function(e){var b=e.data,c=b.C;if(c&&b.w===this.name&&!this.clients[c]&&(this.a("before-connect",e),!e.defaultPrevented)){if(b=(b=e.event.ports)&&b[0])e.T(b),this.l(b),b.start();this.W(c,e.I);e.u();
this.a("connected",c)}};d.prototype.onDisconnect=function(e){var b=this.clients[e.data];b&&(this.a("before-disconnect",e),e.defaultPrevented||(this.S(b.id),e.u(),this.a("disconnected",b.id)))};d.prototype.ja=function(e){this.a("before-method",e);if(!e.defaultPrevented){var b=e.data,c=b.name,a,d=this.methods[c];if(!d)throw g(4,c);try{a=d.apply(this,b.X)}catch(f){a=f}e.u(a)}};d.prototype.la=function(e){this.a("on",e.data)};d.prototype.ka=function(e){this.a("off",e.data)};d.prototype.W=function(e,b){this.clients[e]=
{id:e,port:b}};d.prototype.S=function(e){delete this.clients[e]};d.prototype.G=function(e){e(this,{uuid:m});return this};d.prototype.disconnect=function(e){this.S(e.id);k("disconnect").set({s:e.id,f:!0}).send(e.port)};d.prototype.g=function(){delete this.clients;this.v();this.o()};h=d.prototype;h.broadcast=h.Y;h.destroy=h.g;h.method=h.method;h.plugin=h.G},{"./message":4,"./utils":7}],7:[function(l,f,d){d.K=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var f=16*
Math.random()|0;return("x"==d?f:f&3|8).toString(16)})};d.j=function(){var d={};d.H=new Promise(function(f,k){d.resolve=f;d.reject=k});return d}},{}]},{},[1]);
