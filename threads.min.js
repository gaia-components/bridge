(function p(f,e,g){function m(d,b){if(!e[d]){if(!f[d]){var c="function"==typeof require&&require;if(!b&&c)return c(d,!0);if(k)return k(d,!0);c=Error("Cannot find module '"+d+"'");throw c.code="MODULE_NOT_FOUND",c;}c=e[d]={h:{}};f[d][0].call(c.h,function(a){var c=f[d][1][a];return m(c?c:a)},c,c.h,p,f,e,g)}return e[d].h}for(var k="function"==typeof require&&require,h=0;h<g.length;h++)m(g[h]);return m})({1:[function(l){var f={service:l("../src/service"),client:l("../src/client"),sa:l("../src/message")};
"u"!=(typeof define)[0]?define([],function(){return f}):self.threads=f},{"../src/client":2,"../src/message":4,"../src/service":6}],2:[function(l,f){function e(c,a,b){if(!(this instanceof e))return new e(c,a);"object"==typeof c&&(b=c.timeout,a=c.endpoint,c=c.v);this.id=d();this.v=c;this.timeout=b;this.endpoint=a||this.endpoint;if(!this.endpoint)throw g(1);this.O(this.endpoint);this.i=new Set;this.m=h.m(this.id).b("_push",this.fa.bind(this))}function g(c,a){for(var b=[],d=1;d<arguments.length;++d)b[d-
1]=arguments[d];return Error({1:"an endpoint must be defined",2:'Unable to establish a connection with "'+b[0]+'". Either the target endpoint is not alive or the Service is not `.listen()`ing.',3:'Method "'+b[0]+"\" didn't get a response. Either the target endpoint is not alive or the Service is not `.listen()`ing."}[c])}var m=l("./message/port-adaptors"),k=l("./emitter"),h=l("./message"),d=l("./utils").J;f.h=e;e.prototype={connect:function(){var c=this;if(this.A)return this.A;var a=new MessageChannel;
this.channel=a.port1;this.channel.start();var b={B:this.id,v:this.v};return this.A=this.message("_connect").set("transfer",[a.port2]).set("data",b).l(a.port1).send().then(function(a){a.event.target===c.channel?c.O(c.channel):(c.channel.close(),delete c.channel);c.m.l(c.port)}).catch(function(a){"timeout"==(a&&a.message)&&(a=g(2,c.v),console.error(a.message));throw a;})},disconnect:function(c){var a=this;if(!this.A)return Promise.resolve();c={f:c&&c.f,data:this.id};this.ba();return this.message("_disconnect").set(c).send().then(function(){return a.ea()})},
method:function(c,a){for(var b=[],d=1;d<arguments.length;++d)b[d-1]=arguments[d];var e=this;return this.connect().then(function(){return e.message("_method").set({s:e.v,data:{name:c,W:b}}).send()}).then(function(a){return a.value}).catch(function(a){"timeout"==(a&&a.message)&&(a=g(3,c),console.error(a.message));throw a;})},F:function(c){c(this,{Emitter:k,uuid:d});return this},message:function(c){var a=this,b=h(c).set("port",this.port).b("response",function(){return a.i.delete(b)}).b("cancel",function(){return a.i.delete(b)});
!isNaN(this.timeout)&&0<=this.timeout&&b.set("timeout",this.timeout);this.i.add(b);return b},ba:function(){this.i.forEach(function(c){c.cancel()});this.i.clear()},ga:function(){var c=[];this.i.forEach(function(a){return c.push(a.ta)});return Promise.all(c)},fa:function(c){this.M(c.data.type,c.data.data)},ea:function(){var c=this;delete this.A;this.ga().then(function(){c.channel&&c.channel.close();c.M("disconnected")})},O:function(c){this.port=m(c)},g:function(){var c=this;return this.disconnect().then(function(){c.ca||
(c.ca=!0,c.m.g(),c.Z(),c.port=c.endpoint=c.m=null)})},Z:k.prototype.o,M:k.prototype.a};e.prototype.b=function(c,a){var b=this;this.connect().then(function(){k.prototype.b.call(b,c,a);b.message("_on").set("noRespond",!0).set("data",{name:c,B:b.id}).send(b.port)});return this};e.prototype.o=function(b,a){var d=this;this.connect().then(function(){k.prototype.o.call(d,b,a);d.message("_off").set("noRespond",!0).set("data",{name:b,B:d.id}).send(d.port)});return this};var b=e.prototype;b.destroy=b.g;b.plugin=
b.F;b.method=b.method;b.connect=b.connect;b.disconnect=b.disconnect;b.on=b.b;b.off=b.o},{"./emitter":3,"./message":4,"./message/port-adaptors":5,"./utils":7}],3:[function(l,f){function e(f){if(f)return Object.assign(f,e.prototype)}f.h=e;e.prototype={b:function(e,f){this.c||(this.c={});this.c[e]||(this.c[e]=[]);this.c[e].push(f);return this},o:function(e,f){if(this.c)switch(arguments.length){case 0:this.c={};break;case 1:delete this.c[e];break;default:var g=this.c[e];if(!g)return;var d=g.indexOf(f);
~d&&g.splice(d,1)}return this},a:function(e,f){if(this.c)for(var g=this.c[e]||[],g=g.concat(this.c["*"]||[]),d=0;d<g.length;d++)g[d].call(this,f,e);return this}};var g=e.prototype;g.off=g.o;g.on=g.b},{}],4:[function(l,f,e){function g(a){this.N=!1;this.L=null;this.C=[];this.j=b();this.onMessage=this.onMessage.bind(this);this.D=this.D.bind(this);"object"===typeof a?this.oa(a):this.pa(a)}function m(a){this.name=a;this.ports=new Set;this.onMessage=this.onMessage.bind(this);this.listen=this.listen.bind(this);
this.unlisten=this.unlisten.bind(this)}function k(a,b){for(var c=1;c<arguments.length;++c);return Error({1:".send() can only be called once",2:"response already sent for this message",3:"a port must be defined",4:"timeout"}[a])}var h=l("./port-adaptors"),d=l("../emitter");l=l("../utils");var b=l.j,c=l.J;e=f.h=function(a){return new g(a)};e.m=function(a){return new m(a)};e.K=m;e.i=g;g.prototype={timeout:1E3,pa:function(a){this.id=c();this.type=a;this.ma=!1;this.s="*"},oa:function(a){this.P=!1;this.S(a.source||
a.target);this.event=a;Object.assign(this,a.data)},S:function(a){this.H=h(a,{ready:!0});return this},set:function(a,b){"object"==typeof a?Object.assign(this,a):this[a]=b;return this},na:function(){return{id:this.id,type:this.type,data:this.data,s:this.s,f:this.f}},U:function(){this.defaultPrevented=!0},send:function(a){if(this.ma)throw k(1);var b=this.na(),c=!this.f;this.port=a?h(a):this.port;if(!this.port)throw k(3);c?(this.l(this.port),this.L=0===this.timeout?null:setTimeout(this.D,this.timeout)):
this.j.resolve();this.port.postMessage(b,this.aa());return this.j.G},aa:function(){return this.qa||this.event&&this.event.ports},onMessage:function(a){a.data.response&&a.data.id===this.id&&!this.N&&this.la(a)},D:function(){this.ua||this.j.reject(k(4));this.I()},l:function(a){a=h(a);a.addListener(this.onMessage);this.C.push(a);return this},w:function(){var a=this;this.C.forEach(function(b){return b.removeListener(a.onMessage)});this.C=[]},cancel:function(){this.I();this.N=!0;this.a("cancel")},I:function(){clearTimeout(this.L);
this.w()},u:function(a){function b(a){d({type:"resolve",value:a})}function c(a){d({type:"reject",value:a&&a.message||a})}function d(a){e.response=a;e.H.postMessage({id:e.id,response:a},e.qa)}if(this.P)throw k(2);if(this.H&&!this.f){var e=this;this.P=!0;a instanceof Error&&c(a);Promise.resolve(a).then(b,c).catch(c)}},T:function(a){var b=this;return this.set("silentTimeout",!0).send(a).then(function(a){return b.u(a.value)})},la:function(a){var b=a.data.response,c="reject"==b.type?b.value:b;b.event=
a;this.response=b;this.I();this.j[this.response.type](c);this.a("response",b)}};f=g.prototype;f.forward=f.T;f.respond=f.u;f.preventDefault=f.U;f.cancel=f.cancel;f.send=f.send;f.set=f.set;d(g.prototype);m.prototype={l:function(a){a=h(a||self,{m:!0});if(!this.ports.has(a))return a.addListener(this.onMessage,this.l),this.ports.add(a),this},w:function(){var a=this;this.ports.forEach(function(b){b.removeListener(a.onMessage,a.w)})},onMessage:function(a){if(a.data.id&&a.data.type&&this.da(a.data.s)&&(a=
new g(a),this.a("message",a),!a.defaultPrevented))try{this.a(a.type,a)}catch(b){throw a.u(b),b;}},da:function(a){return a==this.name||"*"==a||"*"==this.name},g:function(){this.w();delete this.name;return this}};f=m.prototype;f.listen=f.l;f.unlisten=f.w;f.destroy=f.g;d(m.prototype)},{"../emitter":3,"../utils":7,"./port-adaptors":5}],5:[function(l,f){function e(b){this.target=b}function g(b,c,a){b.addEventListener(c,a)}var m=l("../utils").j;f.h=function(b,c){if(!b)throw Error({1:"target is undefined"}[1]);
if(b&&b.addListener)return b;var a=h[b.constructor.name];return a?a(b,c):new e(b)};var k=e.prototype={constructor:e,addListener:function(b){this.target.addEventListener("message",b)},removeListener:function(b){this.target.removeEventListener("message",b)},postMessage:function(b,c){this.target.postMessage(b,c)}},h={HTMLIFrameElement:function(b){var c=d(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(a,
d){c.then(function(){b.contentWindow.postMessage(a,"*",d)})}}},ra:function(b,c){function a(){var a=m();b.postMessage("ready?");g(b,"message",function n(c){"ready"==c.data&&(b.removeEventListener("message",n),a.resolve())});return a.G}var d=c&&c.m,e=c&&c.ready,e=e||d?Promise.resolve():a();d&&(b.postMessage("ready"),g(b,"message",function(a){"ready?"==a.data&&b.postMessage("ready")}));return{target:b,addListener:k.addListener,removeListener:k.removeListener,postMessage:function(a,c){e.then(function(){return b.postMessage(a,
c)})}}},Window:function(b,c){var a=c&&c.ready||b===self,a=a?Promise.resolve():d(b);return{addListener:function(a){window.addEventListener("message",a)},removeListener:function(a){window.removeEventListener("message",a)},postMessage:function(c,d){a.then(function(){return b.postMessage(c,"*",d)})}}},SharedWorker:function(b){b.port.start();return new e(b.port)},SharedWorkerGlobalScope:function(){var b=[];return{postMessage:function(){},addListener:function(c,a){this.onconnect=function(c){c=c.ports[0];
b.push(c);c.start();a(c)};self.addEventListener("connect",this.onconnect)},removeListener:function(c,a){self.removeEventListener("connect",this.onconnect);b.forEach(function(b){b.close();a(b)})}}}},d=function(){if("undefined"!=typeof window){var b=window.opener||window.parent,c=new WeakSet;b!=self&&g(window,"DOMContentLoaded",function q(){window.removeEventListener("DOMContentLoaded",q);b.postMessage("load","*")});g(self,"message",function(b){return"load"==b.data&&c.add(b.source)});return function(b){var d=
b.contentWindow||b;if(c.has(d)||d==window.parent)return Promise.resolve();var e=m();g(window,"message",function n(b){"load"==b.data&&b.source==d&&(window.removeEventListener("message",n),e.resolve())});return e.G}}}()},{"../utils":7}],6:[function(l,f){function e(d){if(!(this instanceof e))return new e(d);k.K.call(this,d);this.clients={};this.methods={};this.b("_disconnect",this.onDisconnect.bind(this)).b("_connect",this.ha.bind(this)).b("_method",this.ia.bind(this)).b("_off",this.ja.bind(this)).b("_on",
this.ka.bind(this));this.g=this.g.bind(this)}function g(d){return Error({4:'method "'+[].slice.call(arguments,1)[0]+"\" doesn't exist"}[d])}var m=l("./utils").J,k=l("./message"),h=k.K;f.h=e;e.prototype=Object.create(h.prototype);e.prototype.method=function(d,b){this.methods[d]=b;return this};e.prototype.X=function(d,b,c){var a=this;this.Y(function(e){c&&!~c.indexOf(e.id)||a.push(d,b,e.id,{f:!0})});return this};e.prototype.push=function(d,b,c,a){a=a&&a.f;var e=this.$(c);return k("_push").set({s:c,
f:a,data:{type:d,data:b}}).send(e.port)};e.prototype.Y=function(d){for(var b in this.clients)d(this.clients[b])};e.prototype.$=function(d){return this.clients[d]};e.prototype.ha=function(d){var b=d.data,c=b.B;if(c&&b.v===this.name&&!this.clients[c]&&(this.a("before-connect",d),!d.defaultPrevented)){if(b=(b=d.event.ports)&&b[0])d.S(b),this.l(b),b.start();this.V(c,d.H);d.u();this.a("connected",c)}};e.prototype.onDisconnect=function(d){var b=this.clients[d.data];b&&(this.a("before-disconnect",d),d.defaultPrevented||
(this.R(b.id),d.u(),this.a("disconnected",b.id)))};e.prototype.ia=function(d){this.a("before-method",d);if(!d.defaultPrevented){var b=d.data,c=b.name,a,e=this.methods[c];if(!e)throw g(4,c);try{a=e.apply(this,b.W)}catch(f){a=f}d.u(a)}};e.prototype.ka=function(d){this.a("on",d.data)};e.prototype.ja=function(d){this.a("off",d.data)};e.prototype.V=function(d,b){this.clients[d]={id:d,port:b}};e.prototype.R=function(d){delete this.clients[d]};e.prototype.F=function(d){d(this,{uuid:m});return this};e.prototype.disconnect=
function(d){this.R(d.id);k("disconnect").set({s:d.id,f:!0}).send(d.port)};e.prototype.g=function(){delete this.clients;this.w();this.o()};h=e.prototype;h.broadcast=h.X;h.destroy=h.g;h.method=h.method;h.plugin=h.F},{"./message":4,"./utils":7}],7:[function(l,f,e){e.J=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var f=16*Math.random()|0;return("x"==e?f:f&3|8).toString(16)})};e.j=function(){var e={};e.G=new Promise(function(f,k){e.resolve=f;e.reject=k});return e}},
{}]},{},[1]);
